package PersonalFinanceManagerWeek2;import javax.swing.*;import java.awt.*;import java.awt.event.*;import java.sql.*;import java.time.LocalDate;import java.time.format.DateTimeFormatter;import java.util.HashMap;// FIX 1: Implement ItemListener (for Choice component) alongside ActionListener (for Button)public class ViewBudgets extends JFrame implements ActionListener, ItemListener {     JButton back;    Choice cCategorySelect;         private String username;    private HashMap<String, BudgetData> budgetMap = new HashMap<>();     private JProgressBar progressBar;    // Define Dark Theme Colors    private static final Color BG_DARK = new Color(25, 25, 25);    private static final Color PANEL_DARK = new Color(40, 40, 40);    private static final Color TEXT_LIGHT = Color.WHITE;    private static final Color ACCENT_BLUE = new Color(30, 100, 255);    private static final Color WARNING_ORANGE = new Color(255, 150, 0);     private static final Color PRIMARY_VALUE = new Color(0, 200, 0);        private static final Color LOW_CONTRAST_TEXT = Color.GRAY;    private static final Color FIELD_BG = new Color(50, 50, 50);    // GUI Labels which will display data    JLabel labelLimit, labelPeriod, labelCurrentSpend, labelRemaining, labelPace;    // Inner class to hold structured budget data    // NOTE: Inner classes should ideally be static if not needing outer class state, but keeping as is for structural consistency.    private class BudgetData {        double targetLimit;        double currentSpend;        LocalDate budgetMonth;        public BudgetData(double targetLimit, double currentSpend, LocalDate budgetMonth) {            this.targetLimit = targetLimit;            this.currentSpend = currentSpend;            this.budgetMonth = budgetMonth;        }    }        ViewBudgets(String username) {        this.username = username;                // --- 1. Fetch all budget and spending data ---        fetchBudgetData();        // --- Frame Setup ---        setTitle("View Budget Status");        setBounds(450, 200, 900, 450);        setLocationRelativeTo(null);        getContentPane().setBackground(BG_DARK);        setLayout(null);        setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);        // --- 1. Left Panel (Details, Labels, and Back Button) ---        JPanel p1 = new JPanel();        p1.setBackground(PANEL_DARK);        p1.setBounds(20, 20, 400, 390);         p1.setLayout(null);        add(p1);        // Heading        JLabel text = new JLabel("VIEW CURRENT BUDGET STATUS");        text.setFont(new Font("Tahoma", Font.BOLD, 18));        text.setForeground(TEXT_LIGHT);        text.setBounds(50, 10, 350, 30);        p1.add(text);        // --- GUI Components Setup ---        int labelX = 30;        int valueX = 220;        int yStart = 60;        int ySpacing = 35;        // 1. User        JLabel lblusername = createLabel("User Account", labelX, yStart);        p1.add(lblusername);        JLabel labelusername = createValueLabel(username, valueX, yStart, TEXT_LIGHT);        p1.add(labelusername);        yStart += ySpacing;        // 2. Budget Category Selection (Live data drives this Choice component)        JLabel lblCategory = createLabel("Budget Category", labelX, yStart);        p1.add(lblCategory);                cCategorySelect = new Choice();        cCategorySelect.setBounds(valueX, yStart, 150, 25);        // FIX: Use addItemListener() for Choice component        cCategorySelect.addItemListener(this);         cCategorySelect.setBackground(FIELD_BG);        cCategorySelect.setForeground(TEXT_LIGHT);        p1.add(cCategorySelect);        yStart += ySpacing;                // Populate the Choice component (only if data exists)        for (String category : budgetMap.keySet()) {            cCategorySelect.add(category);        }                // 3. Target Limit        JLabel lblLimit = createLabel("Target Limit (Rs)", labelX, yStart);        p1.add(lblLimit);        labelLimit = createValueLabel("", valueX, yStart, WARNING_ORANGE, true);         p1.add(labelLimit);        yStart += ySpacing;        // 4. Budget Period        JLabel lblPeriod = createLabel("Budget Period", labelX, yStart);        p1.add(lblPeriod);        labelPeriod = createValueLabel("", valueX, yStart, TEXT_LIGHT);         p1.add(labelPeriod);        yStart += ySpacing;        // 5. Current Spend        JLabel lblCurrentSpend = createLabel("Current Spend (Rs)", labelX, yStart);        p1.add(lblCurrentSpend);        labelCurrentSpend = createValueLabel("", valueX, yStart, WARNING_ORANGE, true);         p1.add(labelCurrentSpend);        yStart += ySpacing;        // 6. Remaining Balance        JLabel lblRemaining = createLabel("Remaining Balance", labelX, yStart);        p1.add(lblRemaining);        labelRemaining = createValueLabel("", valueX, yStart, PRIMARY_VALUE, true);         p1.add(labelRemaining);        yStart += ySpacing;        // 7. Spending Pace        JLabel lblPace = createLabel("Spending Pace", labelX, yStart);        p1.add(lblPace);        labelPace = createValueLabel("", valueX, yStart, TEXT_LIGHT);         p1.add(labelPace);        yStart += ySpacing + 20;        // --- Back Button ---        back = new JButton("Back");        back.setBackground(ACCENT_BLUE);        back.setForeground(Color.WHITE);        back.setBounds(150, 340, 100, 35);         back.setFont(new Font("Tahoma", Font.BOLD, 14));        back.addActionListener(this); // Handled by ActionListener        p1.add(back);        // --- 2. Right Panel (Progress Bar and Placeholder) ---        JPanel p2 = new JPanel();        p2.setBackground(BG_DARK);        p2.setBounds(440, 20, 440, 400);        p2.setLayout(null);         add(p2);        // --- Progress Bar ---        progressBar = new JProgressBar(0, 100);         progressBar.setBounds(30, 100, 380, 40);         progressBar.setStringPainted(true);        progressBar.setForeground(PRIMARY_VALUE);        progressBar.setBackground(PANEL_DARK);        p2.add(progressBar);        // --- Budget Visualization Placeholder ---        JLabel placeholder = new JLabel("Budget Visualization Placeholder");        placeholder.setForeground(LOW_CONTRAST_TEXT);        placeholder.setFont(new Font("Tahoma", Font.ITALIC, 16));        placeholder.setBounds(90, 200, 300, 30);         p2.add(placeholder);        // --- Initial Load ---        updateMetricsDisplay();        setVisible(true);    }        // --- DATABASE: Fetch Budget Data ---    private void fetchBudgetData() {        try {            Conn c = new Conn();            // Fetch all budget targets set by the user            String budgetQuery = "SELECT budget_id, category, target_limit, budget_month FROM budget WHERE username = '"+username+"'";                        // FIX: Use separate Statement objects for nested queries to prevent 'ResultSet closed' error            Statement sBudget = c.c.createStatement();            ResultSet rsBudget = sBudget.executeQuery(budgetQuery);                        budgetMap.clear();            while (rsBudget.next()) {                String category = rsBudget.getString("category");                double limit = rsBudget.getDouble("target_limit");                LocalDate month = rsBudget.getDate("budget_month").toLocalDate();                                // --- Nested Query Setup ---                Statement sSpending = c.c.createStatement();                                 // Fetch total spending for this specific category and month                String spendingQuery = "SELECT SUM(amount) AS CurrentSpend FROM transaction_record WHERE username = '"+username+"' AND trans_type = 'Expense' AND category = '"+category+"' AND trans_date >= '"+month.toString()+"' AND trans_date < DATE_ADD('"+month.toString()+"', INTERVAL 1 MONTH)";                ResultSet rsSpending = sSpending.executeQuery(spendingQuery);                                double currentSpend = 0.0;                if (rsSpending.next()) {                    currentSpend = rsSpending.getDouble("CurrentSpend");                }                                // Close inner result set and statement immediately                rsSpending.close();                sSpending.close();                                 // Store data in the HashMap                budgetMap.put(category, new BudgetData(limit, currentSpend, month));            }                        // Close outer result set and statement            rsBudget.close();            sBudget.close();                    } catch (SQLException e) {            e.printStackTrace();            JOptionPane.showMessageDialog(this, "Error fetching budget data: " + e.getMessage(), "Database Error", JOptionPane.ERROR_MESSAGE);        }    }        // --- Update GUI Metrics ---    private void updateMetricsDisplay() {        if (cCategorySelect.getItemCount() == 0) {            labelLimit.setText("N/A");            labelPeriod.setText("N/A");            labelCurrentSpend.setText("Rs 0");            labelRemaining.setText("Rs 0");            labelPace.setText("No Budgets Set");            progressBar.setMaximum(100);            progressBar.setValue(0);            return;        }        String selectedCategory = cCategorySelect.getSelectedItem();        BudgetData data = budgetMap.get(selectedCategory);                if (data == null) return;                double limit = data.targetLimit;        double spent = data.currentSpend;        double remaining = limit - spent;        double percentage = (spent / limit) * 100;                // --- 1. Update Left Panel Metrics ---        labelLimit.setText("Rs " + String.format("%,.0f", limit));        labelPeriod.setText(data.budgetMonth.format(DateTimeFormatter.ofPattern("MMMM yyyy")));        labelCurrentSpend.setText("Rs " + String.format("%,.0f", spent));                // Remaining Balance Color        Color remainingColor = (remaining >= 0) ? PRIMARY_VALUE : WARNING_ORANGE;        labelRemaining.setForeground(remainingColor);        labelRemaining.setText("Rs " + String.format("%,.0f", remaining));        // Spending Pace        String paceText;        if (percentage >= 100) {            paceText = "OVER BUDGET";            labelPace.setForeground(WARNING_ORANGE);        } else if (percentage >= 85) {            paceText = "Approaching Limit";            labelPace.setForeground(WARNING_ORANGE);        } else {            paceText = "On Track (" + String.format("%.0f%%", percentage) + ")";            labelPace.setForeground(PRIMARY_VALUE);        }        labelPace.setText(paceText);                // --- 2. Update Progress Bar ---        progressBar.setMaximum((int) limit);        progressBar.setValue((int) spent);                if (percentage >= 85) {            progressBar.setForeground(WARNING_ORANGE);        } else {            progressBar.setForeground(PRIMARY_VALUE);        }                progressBar.setString(String.format("%.1f%% Used", percentage));    }    // Helper method to create standard labels    private JLabel createLabel(String text, int x, int y) {        JLabel label = new JLabel(text);        label.setBounds(x, y, 150, 25);        label.setForeground(TEXT_LIGHT);        return label;    }    // Helper method to create value labels    private JLabel createValueLabel(String text, int x, int y, Color color) {        return createValueLabel(text, x, y, color, false);    }    private JLabel createValueLabel(String text, int x, int y, Color color, boolean isBold) {        JLabel label = new JLabel(text);        label.setBounds(x, y, 150, 25);        label.setForeground(color);        if (isBold) {            label.setFont(new Font("Tahoma", Font.BOLD, 14));        } else {            label.setFont(new Font("Tahoma", Font.PLAIN, 12));        }        return label;    }    public void actionPerformed(ActionEvent ae) {        if (ae.getSource() == back) {            setVisible(false);            dispose();        }         // Note: cCategorySelect events are handled by itemStateChanged    }        // FIX 3: Implement ItemListener's required method    @Override    public void itemStateChanged(ItemEvent ie) {        if (ie.getSource() == cCategorySelect) {            // Update metrics when a new category is selected from the dropdown            updateMetricsDisplay();        }    }    public static void main(String[] args) {        new ViewBudgets("sarmad");    }}